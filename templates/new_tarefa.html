<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Nova Tarefa</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Adicionar Tarefa ao Projeto: {{ projeto['nome'] }}</h1>
    <form method="post">
        <label for="atividade_id">ID da Atividade (ex: 1.1, 2.1.1)</label>
        <input type="text" name="atividade_id" id="atividade_id">

        <label for="descricao">Descrição da Tarefa</label>
        <textarea name="descricao" id="descricao" required></textarea>
        
        <label for="data_inicio">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio">

        <label for="responsavel_pm">Responsável PM</label>
        <select name="responsavel_pm" id="responsavel_pm" multiple size="5">
            {% for tecnico in tecnicos %}
                <option value="{{ tecnico }}">{{ tecnico }}</option>
            {% endfor %}
        </select>
        <small>Segure Ctrl (ou Cmd em Mac) para selecionar mais de um.</small>

        <label for="responsavel_cm">Responsável CM</label>
        <select name="responsavel_cm" id="responsavel_cm" multiple size="5">
            {% for tecnico in tecnicos %}
                <option value="{{ tecnico }}">{{ tecnico }}</option>
            {% endfor %}
        </select>
        <small>Segure Ctrl (ou Cmd em Mac) para selecionar mais de um.</small>
        
        <label for="predecessoras">Predecessoras (Depende de):</label>
        <select name="predecessoras" id="predecessoras" multiple size="8">
            {% for task in all_tasks %}
                <option value="{{ task.atividade_id }}" data-end-date="{{ task.data_termino or '' }}">
                    {{ task.atividade_id }} - {{ task.descricao }}
                </option>
            {% endfor %}
        </select>
        <small>Segure Ctrl (ou Cmd em Mac) para selecionar mais de um.</small>
        
        <button type="submit">Salvar Tarefa</button>
    </form>
    <a href="{{ url_for('checklist_projeto', projeto_id=projeto['id']) }}" class="button">Cancelar</a>
</div>

<script>
$(document).ready(function() {
    $('#predecessoras').on('change', function() {
        let latestEndDate = null;
        
        $(this).find('option:selected').each(function() {
            const endDateStr = $(this).data('end-date');
            if (endDateStr) {
                const parts = endDateStr.split('-');
                const endDate = new Date(parts[0], parts[1] - 1, parts[2]);

                if (latestEndDate === null || endDate > latestEndDate) {
                    latestEndDate = endDate;
                }
            }
        });

        if (latestEndDate) {
            latestEndDate.setDate(latestEndDate.getDate() + 1);
            const newStartDate = latestEndDate.toISOString().split('T')[0];
            $('#data_inicio').val(newStartDate);
        }
    });
});
</script>
</body>
</html>