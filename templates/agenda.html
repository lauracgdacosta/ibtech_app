<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Módulo de Agenda</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.14/index.global.min.js'></script>
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    
    <style>
        .container {
            max-width: 95%;
        }
        .fc {
            max-width: 100%;
            margin: 20px auto;
        }
        .fc-event-main {
            cursor: pointer;
        }
        .fc-daygrid-day {
            cursor: pointer;
        }
        .fc th, .fc td {
            text-align: center;
            padding: 2px;
            vertical-align: top;
        }
        .fc .fc-daygrid-day-top {
            justify-content: flex-end;
            padding: 4px;
        }
        .tippy-box[data-theme~='light-border'] {
            border: 2px solid #3498db;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .fc-event-title {
            white-space: normal !important;
            overflow: visible !important;
            font-size: 0.85em;
            padding: 2px 4px;
        }
    </style>
</head>
<body>
    <div style="background-color: #34495e; color: white; padding: 10px 20px; text-align: right; margin-bottom: 15px;">
        {% if session.user_name %}
            <span>Bem-vindo, <strong>{{ session.user_name }}</strong>!</span>
            <a href="{{ url_for('logout') }}" style="color: #ecf0f1; margin-left: 15px; text-decoration: none;">Sair</a>
        {% endif %}
    </div>

    <div class="container">
        <div class="header-actions">
            <h1>Módulo de Agenda</h1>
            <div class="actions-group">
                {% if check_permission('agenda', 'can_create') %}
                    <a href="{{ url_for('new_agenda') }}" class="button new">Novo Agendamento</a>
                {% endif %}
                <a href="{{ url_for('index') }}" class="button">Voltar ao Início</a>
            </div>
        </div>
        
        <div id='calendar'></div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            locale: 'pt-br',
            buttonText: {
                today: 'Hoje',
                month: 'Mês',
                week: 'Semana',
                day: 'Dia'
            },
            
            eventDisplay: 'block',
            displayEventTime: false, 

            events: '/api/agendamentos',
            selectable: true, 
            
            dateClick: function(info) {
                var clickedDate = info.dateStr;
                var newEventUrl = `/new_agenda?data_agendamento=${clickedDate}`;
                window.location.href = newEventUrl;
            },

            // --- ALTERAÇÃO APLICADA AQUI: Tooltip agora exibe todos os detalhes ---
            eventMouseEnter: function(info) {
                // Monta o conteúdo do tooltip com todos os campos disponíveis
                let content = `<div style="text-align: left; padding: 5px; font-size: 0.9em;">`;
                
                if (info.event.extendedProps.horario) {
                    content += `<strong>Horário:</strong> ${info.event.extendedProps.horario}<br>`;
                }
                content += `<strong>Cliente:</strong> ${info.event.extendedProps.cliente || 'Não informado'}<br>`;
                content += `<strong>Técnico:</strong> ${info.event.extendedProps.tecnico || 'Não informado'}<br>`;
                content += `<strong>Motivo:</strong> ${info.event.extendedProps.motivo || 'Não informado'}<br>`;
                content += `<strong>Status:</strong> ${info.event.extendedProps.status || 'Não informado'}<br>`;
                content += `<hr style="margin: 4px 0; border-top: 1px solid #eee;">`;
                content += `<strong>Descrição:</strong> ${info.event.extendedProps.descricao || 'Nenhuma'}`;
                
                content += `</div>`;

                tippy(info.el, {
                    content: content,
                    allowHTML: true,
                    placement: 'auto',
                    theme: 'light-border',
                    animation: 'scale-subtle'
                });
            },

            eventClick: function(info) {
                info.jsEvent.preventDefault(); 
                var eventId = info.event.id;

                if (confirm("Deseja editar este agendamento?")) {
                    window.location.href = `/edit_agenda/${eventId}`;
                } else {
                    if (confirm("ATENÇÃO: Deseja EXCLUIR este agendamento? A ação não pode ser desfeita.")) {
                        fetch(`/delete_agenda/${eventId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        }).then(response => {
                            if (response.ok) {
                                info.event.remove();
                                alert('Agendamento excluído com sucesso!');
                            } else {
                                alert('Ocorreu um erro ao excluir o agendamento.');
                            }
                        });
                    }
                }
            }
        });

        calendar.render();
    });
    </script>
</body>
</html>