<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Checklist do Projeto: {{ projeto['nome'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .task-completed { text-decoration: line-through; color: #95a5a6; }
        .task-completed td { background-color: #f8f9f9; }
        .task-header { background-color: #eef2f5; font-weight: bold; color: #2c3e50; }
        .task-header td { border-bottom: 2px solid #3498db; }
        .task-header .actions { text-align: right; }
        .task-header { cursor: pointer; }
        .task-header:hover { background-color: #e1e9f0; }

        /* --- NOVOS ESTILOS PARA IMPRESSÃO --- */
        .print-only { display: none; } /* Esconde o texto do status na visão normal */

        @media print {
            /* Esconde tudo o que não queremos na impressão */
            body { margin: 20px; font-size: 12px; }
            .container { max-width: 100%; margin: 0; padding: 0; box-shadow: none; }
            .header-actions { display: none; }
            .actions { display: none; } /* Esconde a coluna de ações inteira */
            .toggle-form { display: none; } /* Esconde o botão de toggle do status */
            
            /* Mostra o texto simples do status apenas na impressão */
            .print-only { display: block; } 

            /* Garante que todos os títulos e tarefas fiquem visíveis */
            tbody tr { display: table-row !important; }

            /* Remove cores de fundo para economizar tinta */
            .task-header, .task-completed td { background-color: #ffffff !important; }
            tr { page-break-inside: avoid; }
            
            /* Adiciona um título de impressão */
            .print-title { display: block; text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 20px;}
        }
        .no-print { /* Classe para o novo botão de imprimir */
             background-color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="print-only print-title">Checklist do Projeto: {{ projeto['nome'] }}</h1>

        <div class="header-actions">
            <h1>Checklist: {{ projeto['nome'] }}</h1>
            <div class="actions-group">
                
                {% if check_permission('projetos', 'can_create') %}
                    <a href="{{ url_for('new_titulo', projeto_id=projeto.id) }}" class="button new" style="background-color: #5bc0de;">Adicionar Título</a>
                    <a href="{{ url_for('new_tarefa', projeto_id=projeto.id) }}" class="button new">Adicionar Tarefa</a>
                {% endif %}
                <button onclick="window.print();" class="button no-print">Imprimir Checklist</button>
                <a href="{{ url_for('projetos') }}" class="button">Voltar à Lista de Projetos</a>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Item</th>
                    <th>Atividade</th>
                    <th>Datas</th>
                    <th>Duração</th>
                    <th>Responsáveis</th>
                    <th>Local</th>
                    <th>Status</th>
                    <th class="actions">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for tarefa in tarefas %}
                    {% if tarefa['tipo'] == 'tarefa' %}
                        <tr class="task-item {% if tarefa['status'] == 'Concluída' %}task-completed{% endif %}">
                            <td>{{ tarefa['atividade_id'] }}</td>
                            <td>
                                {{ tarefa['descricao'] }}
                                {% if tarefa['observacoes'] %}
                                    <p style="font-size: 0.9em; color: #7f8c8d; margin: 5px 0 0 0;">Obs: {{ tarefa['observacoes'] | default('', true) }}</p>
                                {% endif %}
                            </td>
                            <td>{{ tarefa['data_inicio'] | dateformat }} - {{ tarefa['data_termino'] | dateformat }}</td>
                            <td>{{ tarefa['duracao_calculada'] }}</td>
                            <td>
                                {% if tarefa.responsavel_pm and tarefa.responsavel_cm %}
                                    <b>PM:</b> {{ tarefa.responsavel_pm }}<br><b>CM:</b> {{ tarefa.responsavel_cm }}
                                {% elif tarefa.responsavel_pm %}
                                    <b>PM:</b> {{ tarefa.responsavel_pm }}
                                {% elif tarefa.responsavel_cm %}
                                    <b>CM:</b> {{ tarefa.responsavel_cm }}
                                {% else %}
                                    ---
                                {% endif %}
                            </td>
                            <td>{{ tarefa['local_execucao'] or '---' }}</td>
                            <td>
                                <form class="toggle-form" action="{{ url_for('toggle_tarefa_status', tarefa_id=tarefa['id']) }}" method="post" style="margin:0;">
                                     <button type="submit" class="button" style="padding: 8px 12px; width: 100%; background-color: {% if tarefa['status'] == 'Concluída' %}#2ecc71{% else %}#bdc3c7{% endif %};">
                                        {{ tarefa['status'] }}
                                    </button>
                                </form>
                                <span class="print-only">{{ tarefa['status'] }}</span>
                            </td>
                            <td class="actions">
                                {% if check_permission('projetos', 'can_edit') %}
                                    <a href="{{ url_for('edit_tarefa', tarefa_id=tarefa['id']) }}" class="button edit">Editar</a>
                                {% endif %}
                                {% if check_permission('projetos', 'can_delete') %}
                                    <form action="{{ url_for('delete_tarefa', tarefa_id=tarefa['id']) }}" method="post" onsubmit="return confirm('Tem certeza?');" style="display:inline;">
                                         <button type="submit" class="button delete">Excluir</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr class="task-header">
                            <td colspan="7">
                                {{ tarefa['atividade_id'] }} {{ tarefa['descricao'] }}
                            </td>
                            <td class="actions">
                                {% if check_permission('projetos', 'can_edit') %}
                                    <a href="{{ url_for('edit_titulo', tarefa_id=tarefa['id']) }}" class="button edit">Editar</a>
                                {% endif %}
                                {% if check_permission('projetos', 'can_delete') %}
                                    <form action="{{ url_for('delete_tarefa', tarefa_id=tarefa['id']) }}" method="post" onsubmit="return confirm('Tem certeza que deseja excluir este título?');" style="display:inline;">
                                         <button type="submit" class="button delete">Excluir</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endif %}
                {% else %}
                <tr><td colspan="8" style="text-align:center;">Nenhuma tarefa adicionada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        $(document).ready(function() {
            // A função de expandir/recolher continua a mesma
            $('tbody tr').not('.task-header').hide();
            $('.task-header').on('click', function() {
                $(this).nextUntil('.task-header').slideToggle('fast');
            });
        });
    </script>
</body>
</html>