<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Módulo de Visitas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div style="background-color: #34495e; color: white; padding: 10px 20px; text-align: right; margin-bottom: 15px;">
    {% if session.user_name %}
        <span>Bem-vindo, <strong>{{ session.user_name }}</strong>!</span>
        <a href="{{ url_for('logout') }}" style="color: #ecf0f1; margin-left: 15px; text-decoration: none;">Sair</a>
    {% endif %}
    </div>
    <div class="container">
        <div class="header-actions">
            <h1>Módulo de Visitas</h1>
            <div class="actions-group">
                <a href="{{ url_for('new_visita') }}" class="button new">Nova Visita</a>
                <a href="{{ url_for('index') }}" class="button">Voltar ao Início</a>
            </div>
        </div>
        
        <h2>Visitas Agendadas</h2>
        <div class="controls">
            <input type="text" id="filterInput" placeholder="Filtrar...">
            <select id="sortSelect">
                <option value="0">Ordenar por Localidade/Órgão (A-Z)</option>
                <option value="0_desc">Ordenar por Localidade/Órgão (Z-A)</option>
                <option value="2">Ordenar por Equipe (A-Z)</option>
                <option value="2_desc">Ordenar por Equipe (Z-A)</option>
                <option value="1">Ordenar por Data 1ª Rodada</option>
                <option value="1_desc">Ordenar por Data 1ª Rodada (Decrescente)</option>
            </select>
        </div>
        <button onclick="abrirTelaCheia('tabela-visitas')">Abrir Tabela em Tela Cheia</button>
        <div style="overflow-x: auto;">
            <table id="tabela-visitas">
                <thead>
                    <tr>
                        <th>Localidade/Órgão</th>
                        <th>Data 1ª Rodada</th>
                        <th>Equipe 1</th>
                        <th>Técnico 1</th>
                        <th>Status 1ª Rodada</th>
                        <th>Data 2ª Rodada</th>
                        <th>Equipe 2</th>
                        <th>Técnico 2</th>
                        <th>Status 2ª Rodada</th>
                        <th>Data 3ª Rodada</th>
                        <th>Equipe 3</th>
                        <th>Técnico 3</th>
                        <th>Status 3ª Rodada</th>
                        <th>Data 4ª Rodada</th>
                        <th>Equipe 4</th>
                        <th>Técnico 4</th>
                        <th>Status 4ª Rodada</th>
                        <th>Observações</th>
                        <th style="width: 220px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for visita in visitas %}
                    <tr>
                        <td>{{ visita['localidade_orgao'] }}</td>
                        <td>{{ visita['data_1a_rodada'] }}</td>
                        <td>{{ visita['equipe_1'] }}</td>
                        <td>{{ visita['tecnico_1'] }}</td>
                        <td>{{ visita['status_1a_rodada'] }}</td>
                        <td>{{ visita['data_2a_rodada'] }}</td>
                        <td>{{ visita['equipe_2'] }}</td>
                        <td>{{ visita['tecnico_2'] }}</td>
                        <td>{{ visita['status_2a_rodada'] }}</td>
                        <td>{{ visita['data_3a_rodada'] }}</td>
                        <td>{{ visita['equipe_3'] }}</td>
                        <td>{{ visita['tecnico_3'] }}</td>
                        <td>{{ visita['status_3a_rodada'] }}</td>
                        <td>{{ visita['data_4a_rodada'] }}</td>
                        <td>{{ visita['equipe_4'] }}</td>
                        <td>{{ visita['tecnico_4'] }}</td>
                        <td>{{ visita['status_4a_rodada'] }}</td>
                        <td>{{ visita['obs'] }}</td>
                        <td class="actions">
                            <a href="{{ url_for('edit_visita', id=visita['id']) }}" class="button edit">Editar</a>
                            <form action="{{ url_for('delete_visita', id=visita['id']) }}" method="post">
                                <button type="submit" class="button delete" onclick="return confirm('Tem certeza que deseja deletar esta visita?');">Deletar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function setupTable(tableId, filterId, sortId) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const filterInput = document.getElementById(filterId);
            const sortSelect = document.getElementById(sortId);

            function filterAndSort() {
                const filterText = filterInput.value.toLowerCase();
                const [sortCol, sortDir] = sortSelect.value.split('_');

                const visibleRows = rows.filter(row => {
                    const textContent = row.textContent.toLowerCase();
                    return textContent.includes(filterText);
                });

                visibleRows.sort((a, b) => {
                    const aText = a.children[sortCol].textContent.toLowerCase();
                    const bText = b.children[sortCol].textContent.toLowerCase();
                    if ([1, 5, 9, 13].includes(parseInt(sortCol))) { // Sort by Date
                        const dateA = new Date(a.children[sortCol].textContent.split('/').reverse().join('-'));
                        const dateB = new Date(b.children[sortCol].textContent.split('/').reverse().join('-'));
                        if (dateA < dateB) return sortDir === 'desc' ? 1 : -1;
                        if (dateA > dateB) return sortDir === 'desc' ? -1 : 1;
                        return 0;
                    } else { // Sort by Text
                        if (aText < bText) return sortDir === 'desc' ? 1 : -1;
                        if (aText > bText) return sortDir === 'desc' ? -1 : 1;
                        return 0;
                    }
                });

                tbody.innerHTML = '';
                visibleRows.forEach(row => tbody.appendChild(row));
            }

            filterInput.addEventListener('input', filterAndSort);
            sortSelect.addEventListener('change', filterAndSort);
            filterAndSort();
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupTable('tabela-visitas', 'filterInput', 'sortSelect');
        });

        function abrirTelaCheia(idTabela) {
            var tabela = document.getElementById(idTabela);
            if (tabela.requestFullscreen) {
                tabela.requestFullscreen();
            } else if (tabela.webkitRequestFullscreen) {
                tabela.webkitRequestFullscreen();
            } else if (tabela.msRequestFullscreen) {
                tabela.msRequestFullscreen();
            }
        }
    </script>
</body>
</html>