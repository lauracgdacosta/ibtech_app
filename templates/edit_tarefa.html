<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Editar Tarefa</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="container">
    <h1>Editar Tarefa</h1>
    <form method="post">
        <label for="atividade_id">Item</label>
        <input type="text" name="atividade_id" value="{{ tarefa['atividade_id'] }}">

        <label for="descricao">Atividade</label>
        <textarea name="descricao" required>{{ tarefa['descricao'] }}</textarea>

        <label for="data_inicio">Data Início</label>
        <input type="date" id="data_inicio" name="data_inicio" value="{{ tarefa['data_inicio'] }}">

        <label for="data_termino">Data Término</label>
        <input type="date" name="data_termino" value="{{ tarefa['data_termino'] }}">

        <label for="responsavel_pm">Responsável PM</label>
        <select name="responsavel_pm">
            <option value="">Selecione</option>
            {% for tecnico in tecnicos %}<option value="{{ tecnico }}" {% if tecnico == tarefa['responsavel_pm'] %}selected{% endif %}>{{ tecnico }}</option>{% endfor %}
        </select>

        <label for="responsavel_cm">Responsável CM</label>
        <select name="responsavel_cm">
            <option value="">Selecione</option>
            {% for tecnico in tecnicos %}<option value="{{ tecnico }}" {% if tecnico == tarefa['responsavel_cm'] %}selected{% endif %}>{{ tecnico }}</option>{% endfor %}
        </select>

        <label for="predecessoras">Predecessoras (Depende de):</label>
        <select name="predecessoras" id="predecessoras" multiple size="8">
            {% for task in all_tasks %}
                <option value="{{ task.atividade_id }}" 
                        data-end-date="{{ task.data_termino or '' }}" 
                        {% if task.atividade_id in (tarefa.predecessoras or '') %}selected{% endif %}>
                    {{ task.atividade_id }} - {{ task.descricao }}
                </option>
            {% endfor %}
        </select>
        <small>Segure Ctrl (ou Cmd em Mac) para selecionar mais de uma.</small>

        <label for="local_execucao">Local de Execução</label>
        <select name="local_execucao">
            <option value="">Selecione</option>
            {% for local in locais %}<option value="{{ local }}" {% if local == tarefa['local_execucao'] %}selected{% endif %}>{{ local }}</option>{% endfor %}
        </select>
        
        <label for="status">Status</label>
        <select name="status" required>
            <option value="Planejada" {% if tarefa['status'] == 'Planejada' %}selected{% endif %}>Planejada</option>
            <option value="Em Andamento" {% if tarefa['status'] == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
            <option value="Atrasada" {% if tarefa['status'] == 'Atrasada' %}selected{% endif %}>Atrasada</option>
            <option value="Suspensa" {% if tarefa['status'] == 'Suspensa' %}selected{% endif %}>Suspensa</option>
            <option value="Concluída" {% if tarefa['status'] == 'Concluída' %}selected{% endif %}>Concluída</option>
            <option value="Cancelada" {% if tarefa['status'] == 'Cancelada' %}selected{% endif %}>Cancelada</option>
        </select>
        
        <label for="observacoes">Observações</label>
        <textarea name="observacoes">{{ tarefa['observacoes'] | default('', true) }}</textarea>

        <button type="submit">Salvar Alterações</button>
        <a href="{{ url_for('checklist_projeto', projeto_id=tarefa['projeto_id']) }}" class="button">Cancelar</a>
    </form>
</div>

<script>
$(document).ready(function() {
    $('#predecessoras').on('change', function() {
        let latestEndDate = null;
        
        // Itera sobre todas as opções selecionadas
        $(this).find('option:selected').each(function() {
            const endDateStr = $(this).data('end-date');
            if (endDateStr) {
                // Converte a string de data YYYY-MM-DD para um objeto Date, evitando problemas de fuso horário
                const parts = endDateStr.split('-');
                const endDate = new Date(parts[0], parts[1] - 1, parts[2]);

                // Encontra a maior data de término entre as selecionadas
                if (latestEndDate === null || endDate > latestEndDate) {
                    latestEndDate = endDate;
                }
            }
        });

        // Se uma data de término válida foi encontrada
        if (latestEndDate) {
            // Adiciona 1 dia à maior data
            latestEndDate.setDate(latestEndDate.getDate() + 1);

            // Formata a nova data de volta para YYYY-MM-DD
            const newStartDate = latestEndDate.toISOString().split('T')[0];

            // Define o valor do campo Data Início
            $('#data_inicio').val(newStartDate);
        }
    });
});
</script>

</body>
</html>