<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Checklist Editável: {{ projeto.nome }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* ... (Estilos CSS da Fase 3 inalterados) ... */
        .checklist-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .checklist-table th, .checklist-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .checklist-table th { background-color: #f2f2f2; font-weight: bold; }
        .task-header-inline td { background-color: #eef2f5; font-weight: bold; color: #2c3e50; cursor: default !important; }
        .task-item-inline td:first-child { padding-left: 25px; cursor: default !important;}
        .task-item-inline[data-level='2'] td:first-child { padding-left: 40px; }
        .task-item-inline[data-level='3'] td:first-child { padding-left: 55px; }
        .col-item { width: 80px; }
        .col-atividade { width: auto; }
        .col-data { width: 110px; text-align: center; }
        .col-duracao { width: 80px; text-align: center; cursor: default !important; }
        .col-responsavel { width: 150px; }
        .col-status { width: 120px; }
        .col-local { width: 120px; }
        .col-obs { width: 200px; font-size: 0.9em; color: #555; }
        .col-actions { width: 80px; text-align: center; cursor: default !important; }
        .btn-delete-task { color: #dc3545; cursor: pointer; font-size: 1.2em; }
        .btn-delete-task:hover { color: #c82333; }
        .editable-cell input, .editable-cell select, .editable-cell textarea { width: 100%; box-sizing: border-box; border: 1px solid #007bff; padding: 5px; font-family: inherit; font-size: inherit; }
        .editable-cell textarea { resize: vertical; min-height: 50px; }
        .editable-cell select[multiple] { min-height: 80px; }
        td.editable { cursor: text; }
        .saving { background-color: #fff3cd !important; opacity: 0.7; }
        .saved-success { background-color: #d4edda !important; transition: background-color 0.5s ease-out; }
        .saved-error { background-color: #f8d7da !important; transition: background-color 0.5s ease-out; }
    </style>
</head>
<body>
    <div style="background-color: #34495e; color: white; padding: 10px 20px; text-align: right; margin-bottom: 15px;">
        {% if session.user_name %}
            <span>Bem-vindo, <strong>{{ session.user_name }}</strong>!</span>
            <a href="{{ url_for('logout') }}" style="color: #ecf0f1; margin-left: 15px; text-decoration: none;">Sair</a>
        {% endif %}
    </div>

    <div class="container">
        <div class="header-actions">
            <h1>Checklist Editável: {{ projeto.nome }}</h1>
            <div class="actions-group">
                <button id="add-task-btn" class="button new">Adicionar Tarefa/Título</button>
                <button id="save-all-btn" class="button edit">Salvar Alterações</button>
                <a href="{{ url_for('projetos') }}" class="button">Voltar à Lista</a>
            </div>
        </div>

        <table class="checklist-table">
            <thead>
                <tr>
                    <th class="col-item">Item</th>
                    <th class="col-atividade">Atividade</th>
                    <th class="col-data">Data Início</th>
                    <th class="col-data">Data Término</th>
                    <th class="col-duracao">Duração</th>
                    <th class="col-responsavel">Responsáveis</th> 
                    <th class="col-status">Status</th>
                    <th class="col-local">Local</th>
                    <th class="col-obs">Observações</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody>
                {% for tarefa in tarefas %}
                    {% if tarefa.tipo == 'titulo' %}
                        <tr class="task-header-inline" data-task-id="{{ tarefa.id }}" data-task-type="titulo">
                            <td class="col-item">{{ tarefa.atividade_id }}</td>
                             <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data"></td>
                            <td class="col-data"></td>
                            <td class="col-duracao"></td>
                            <td class="col-responsavel"></td>
                            <td class="col-status"></td>
                            <td class="col-local"></td>
                            <td class="col-obs"></td>
                            <td class="col-actions">
                                <span class="btn-delete-task" title="Excluir Título">&times;</span>
                            </td>
                        </tr>
                    {% else %}
                        {% set level = (tarefa.atividade_id.count('.') + 1) if tarefa.atividade_id else 1 %}
                        <tr class="task-item-inline" data-task-id="{{ tarefa.id }}" data-task-type="tarefa" data-level="{{ level }}">
                            <td class="col-item">{{ tarefa.atividade_id }}</td>
                            <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data editable" data-field="data_inicio">{{ tarefa.data_inicio | dateformat }}</td>
                            <td class="col-data editable" data-field="data_termino">{{ tarefa.data_termino | dateformat }}</td>
                            <td class="col-duracao">{{ tarefa.duracao_calculada }}</td>
                            <td class="col-responsavel editable" data-field="responsaveis">{{ tarefa.responsaveis or '---' }}</td>
                            <td class="col-status editable" data-field="status">{{ tarefa.status }}</td>
                            <td class="col-local editable" data-field="local_execucao">{{ tarefa.local_execucao or '---' }}</td>
                            <td class="col-obs editable" data-field="observacoes">{{ tarefa.observacoes or '' }}</td>
                            <td class="col-actions">
                                <span class="btn-delete-task" title="Excluir Tarefa">&times;</span>
                            </td>
                        </tr>
                    {% endif %}
                {% else %}
                    <tr>
                        <td colspan="10" style="text-align: center;">Nenhuma tarefa encontrada para este projeto.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>

    <script>
        $(document).ready(function() {
            let activeInput = null;

            function revertToText(cell, displayValue) {
                $(cell).empty().text(displayValue).addClass('editable');
                activeInput = null;
                 // Remove feedback visual após um tempo
                setTimeout(() => {
                    $(cell).removeClass('saved-success saved-error saving');
                }, 1500);
            }

            $('.checklist-table').on('dblclick', 'td.editable', function() {
                if (activeInput) {
                    const cell = $(activeInput).closest('td');
                    revertToText(cell, $(activeInput).data('original-value'));
                }

                const cell = this;
                const originalValue = $(cell).text().trim() === '---' ? '' : $(cell).text().trim();
                const fieldName = $(cell).data('field');
                const taskId = $(cell).closest('tr').data('task-id');
                const taskType = $(cell).closest('tr').data('task-type');

                if (taskType === 'titulo' && !['descricao', 'atividade_id'].includes(fieldName)) {
                    return; // Títulos só editam Descrição e Item (atividade_id)
                }

                $(cell).removeClass('editable');
                $(cell).empty(); 

                let inputElement;
                let isMultiSelect = false;

                // Cria o input apropriado (lógica inalterada da Fase 2)
                if (fieldName === 'descricao' || fieldName === 'observacoes') {
                    inputElement = $('<textarea>').val(originalValue);
                } else if (fieldName === 'data_inicio' || fieldName === 'data_termino') {
                    let dateValue = originalValue;
                    if (originalValue.includes('/')) {
                        const parts = originalValue.split('/');
                        if(parts.length === 3) dateValue = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                    inputElement = $('<input type="date">').val(dateValue);
                } else if (fieldName === 'status') {
                    inputElement = $('<select>');
                    {% for status in status_list %}
                        inputElement.append($('<option>', { value: '{{ status }}', text: '{{ status }}', selected: originalValue === '{{ status }}' }));
                    {% endfor %}
                } else if (fieldName === 'responsaveis') {
                    inputElement = $('<select multiple size="5">'); // Select múltiplo
                    const selectedValues = originalValue.split(',').map(s => s.trim());
                    {% for tecnico in tecnicos_list %}
                        inputElement.append($('<option>', { value: '{{ tecnico }}', text: '{{ tecnico }}', selected: selectedValues.includes('{{ tecnico }}') }));
                    {% endfor %}
                    isMultiSelect = true; // Marca como multi-select
                } else if (fieldName === 'local_execucao') {
                     inputElement = $('<select>');
                     inputElement.append($('<option>', { value: '', text: 'Selecione' }));
                     {% for local in locais_list %}
                        inputElement.append($('<option>', { value: '{{ local }}', text: '{{ local }}', selected: originalValue === '{{ local }}' }));
                    {% endfor %}
                } else { // Default (inclui atividade_id para títulos)
                    inputElement = $('<input type="text">').val(originalValue);
                }

                inputElement.data('original-value', originalValue);
                $(cell).append(inputElement);
                inputElement.focus(); 
                activeInput = inputElement;

                // Listener para salvar via AJAX quando perder o foco (blur)
                inputElement.on('blur', function() {
                    let newValue = $(this).val();
                    const originalValueFromData = $(this).data('original-value');

                    // Para selects múltiplos, pega todos os valores e junta com vírgula
                    if (isMultiSelect) {
                        newValue = $(this).val() ? $(this).val().join(', ') : '';
                    }

                    // Verifica se o valor realmente mudou
                    if (newValue !== originalValueFromData) {
                        $(cell).addClass('saving'); // Feedback visual: salvando

                        // Envia os dados para a API
                        fetch(`/api/tarefa_inline/update/${taskId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                // Incluir 'X-CSRFToken': '' se CSRF estiver habilitado
                            },
                            body: JSON.stringify({
                                field: fieldName,
                                value: newValue
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                $(cell).removeClass('saving').addClass('saved-success'); // Feedback: sucesso
                                // Formata o valor para exibição (datas, múltiplos responsáveis)
                                let displayValue = newValue;
                                if (fieldName === 'data_inicio' || fieldName === 'data_termino') {
                                    if (newValue && newValue.includes('-')) {
                                        const parts = newValue.split('-');
                                        if(parts.length === 3) displayValue = `${parts[2].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[0]}`;
                                    }
                                }
                                if (displayValue === '' && (fieldName === 'responsaveis' || fieldName === 'local_execucao')) {
                                    displayValue = '---';
                                }
                                revertToText(cell, displayValue);
                            } else {
                                $(cell).removeClass('saving').addClass('saved-error'); // Feedback: erro
                                alert(`Erro ao salvar: ${data.message}`);
                                revertToText(cell, originalValueFromData); // Reverte para o valor original em caso de erro
                            }
                        })
                        .catch(error => {
                            $(cell).removeClass('saving').addClass('saved-error'); // Feedback: erro
                            console.error('Erro na requisição:', error);
                            alert('Erro de comunicação ao salvar.');
                            revertToText(cell, originalValueFromData); // Reverte para o valor original
                        });

                    } else {
                        // Se não mudou, apenas reverte para texto
                        revertToText(cell, originalValueFromData);
                    }
                });

                // Listener para Enter/Esc (lógica inalterada da Fase 2)
                 if (inputElement.prop('tagName') !== 'TEXTAREA' && !isMultiSelect) { // Enter não salva multi-select
                    inputElement.on('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault(); 
                            $(this).trigger('blur');
                        } else if (e.key === 'Escape') {
                            revertToText(cell, originalValue); 
                        }
                    });
                } else {
                     inputElement.on('keydown', function(e) {
                         if (e.key === 'Escape') {
                            revertToText(cell, originalValue); 
                        }
                     });
                }
            });

            // Lógica futura para Adicionar e Excluir

        });
    </script>
</body>
</html>