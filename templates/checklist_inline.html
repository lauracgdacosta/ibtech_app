<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Checklist Editável: {{ projeto.nome }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* Estilos CSS da Fase 4 e anteriores */
        .checklist-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .checklist-table th, .checklist-table td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
        .checklist-table th { background-color: #f2f2f2; font-weight: bold; }

        .task-header-inline td { background-color: #eef2f5; font-weight: bold; color: #2c3e50; cursor: default !important; }
        .task-item-inline td:first-child { padding-left: 25px; cursor: default !important;}
        .task-item-inline[data-level='2'] td:first-child { padding-left: 40px; }
        .task-item-inline[data-level='3'] td:first-child { padding-left: 55px; }

        .col-item { width: 80px; }
        .col-atividade { width: auto; }
        .col-data { width: 110px; text-align: center; }
        .col-duracao { width: 80px; text-align: center; }
        .col-responsavel { width: 150px; }
        .col-predecessoras { width: 150px; } /* Nova coluna */
        .col-status { width: 120px; }
        .col-local { width: 120px; }
        .col-obs { width: 200px; font-size: 0.9em; color: #555; }
        .col-actions { width: 80px; text-align: center; cursor: default !important; }

        .btn-delete-task { color: #dc3545; cursor: pointer; font-size: 1.2em; }
        .btn-delete-task:hover { color: #c82333; }

        .editable-cell input, .editable-cell select, .editable-cell textarea {
            width: 100%; box-sizing: border-box; border: 1px solid #007bff; padding: 5px; font-family: inherit; font-size: inherit;
        }
        .editable-cell textarea { resize: vertical; min-height: 50px; }
        .editable-cell select[multiple] { min-height: 80px; }
        td.editable { cursor: text; }
        .col-duracao.editable { cursor: text; } /* Torna duração editável */

        .saving { background-color: #fff3cd !important; opacity: 0.7; }
        .saved-success { background-color: #d4edda !important; transition: background-color 0.5s ease-out; }
        .saved-error { background-color: #f8d7da !important; transition: background-color 0.5s ease-out; }

        .new-task-row td { background-color: #eef2f5; }
        .btn-save-new { background-color: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-cancel-new { background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px;}
    </style>
</head>
<body>
    <div style="background-color: #34495e; color: white; padding: 10px 20px; text-align: right; margin-bottom: 15px;">
        {% if session.user_name %}
            <span>Bem-vindo, <strong>{{ session.user_name }}</strong>!</span>
            <a href="{{ url_for('logout') }}" style="color: #ecf0f1; margin-left: 15px; text-decoration: none;">Sair</a>
        {% endif %}
    </div>

    <div class="container">
        <div class="header-actions">
            <h1>Checklist Editável: {{ projeto.nome }}</h1>
            <div class="actions-group">
                <button id="add-task-btn" class="button new">Adicionar Tarefa</button>
                 <button id="add-title-btn" class="button new" style="background-color: #5bc0de;">Adicionar Título</button>
                <a href="{{ url_for('projetos') }}" class="button">Voltar à Lista</a>
            </div>
        </div>

        <table class="checklist-table">
            <thead>
                 <tr>
                    <th class="col-item">Item</th>
                    <th class="col-atividade">Atividade</th>
                    <th class="col-data">Data Início</th>
                    <th class="col-data">Data Término</th>
                    <th class="col-duracao">Duração (dias)</th>
                    <th class="col-responsavel">Responsáveis</th>
                    <th class="col-predecessoras">Predecessoras</th>
                    <th class="col-status">Status</th>
                    <th class="col-local">Local</th>
                    <th class="col-obs">Observações</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody id="checklist-tbody">
                {% for tarefa in tarefas %}
                    {% if tarefa.tipo == 'titulo' %}
                        <tr class="task-header-inline" data-task-id="{{ tarefa.id }}" data-task-type="titulo">
                            <td class="col-item editable" data-field="atividade_id">{{ tarefa.atividade_id }}</td>
                            <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data"></td> <td class="col-data"></td> <td class="col-duracao"></td>
                            <td class="col-responsavel"></td>
                            <td class="col-predecessoras"></td>
                            <td class="col-status"></td> <td class="col-local"></td>
                            <td class="col-obs"></td>
                            <td class="col-actions"><span class="btn-delete-task" title="Excluir Título">&times;</span></td>
                        </tr>
                    {% else %}
                        {% set level = (tarefa.atividade_id.count('.') + 1) if tarefa.atividade_id else 1 %}
                        <tr class="task-item-inline" data-task-id="{{ tarefa.id }}" data-task-type="tarefa" data-level="{{ level }}">
                            <td class="col-item editable" data-field="atividade_id">{{ tarefa.atividade_id }}</td>
                            <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data editable" data-field="data_inicio">{{ tarefa.data_inicio | dateformat }}</td>
                            <td class="col-data" data-field="data_termino">{{ tarefa.data_termino | dateformat }}</td>
                            <td class="col-duracao editable" data-field="duracao">{{ tarefa.duracao or '' }}</td>
                            <td class="col-responsavel editable" data-field="responsaveis">{{ tarefa.responsaveis or '---' }}</td>
                            <td class="col-predecessoras editable" data-field="predecessoras">{{ tarefa.predecessoras or '' }}</td>
                            <td class="col-status editable" data-field="status">{{ tarefa.status }}</td>
                            <td class="col-local editable" data-field="local_execucao">{{ tarefa.local_execucao or '---' }}</td>
                            <td class="col-obs editable" data-field="observacoes">{{ tarefa.observacoes or '' }}</td>
                            <td class="col-actions"><span class="btn-delete-task" title="Excluir Tarefa">&times;</span></td>
                        </tr>
                    {% endif %}
                {% else %}
                    <tr id="no-tasks-row"><td colspan="11" style="text-align: center;">Nenhuma tarefa encontrada.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const TECNICOS = {{ tecnicos_list | tojson }};
        const STATUS_LIST = {{ status_list | tojson }};
        const LOCAIS_LIST = {{ locais_list | tojson }};
        const PROJETO_ID = {{ projeto.id }};
        let taskData = {};
        {% for tarefa in tarefas %}
            {% if tarefa.tipo == 'tarefa' and tarefa.atividade_id %}
            taskData['{{ tarefa.atividade_id }}'] = { endDate: '{{ tarefa.data_termino or "" }}' };
            {% endif %}
        {% endfor %}
        // console.log("Dados Iniciais das Tarefas:", taskData); // DEBUG original

        $(document).ready(function() {
            let activeInput = null;
            let isAddingNewRow = false;

            function formatDate(dateString) { /* ... (inalterada) ... */ }
            function revertToText(cell, displayValue, updatedFields = null) { /* ... (inalterada) ... */ }
            function updateStartDateFromPredecessors(selectElement) { /* ... (inalterada) ... */ }

            // Lógica de Edição Inline (dblclick)
            $('#checklist-tbody').on('dblclick', 'td.editable', function() { /* ... (inalterada) ... */ });

            // Lógica Adicionar Nova Linha
             function createNewRow(type = 'tarefa') { /* ... (inalterada) ... */ }
            $('#add-task-btn').on('click', function() { createNewRow('tarefa'); });
            $('#add-title-btn').on('click', function() { createNewRow('titulo'); });
            $('#checklist-tbody').on('click', '.btn-cancel-new', function() { /* ... (inalterada) ... */ });
            $('#checklist-tbody').on('click', '.btn-save-new', function() { /* ... (inalterada) ... */ });

            // --- ALTERAÇÃO APLICADA AQUI: Adicionados console.log na Lógica de Exclusão ---
            $('#checklist-tbody').on('click', '.btn-delete-task', function() {
                console.log("Botão Excluir clicado!"); // DEBUG 1: Verifica se o clique é detectado

                const $row = $(this).closest('tr');
                const taskId = $row.data('task-id');
                const taskDesc = $row.find('td').eq(1).text();

                console.log("ID da Tarefa:", taskId); // DEBUG 2: Verifica se o ID foi pego
                console.log("Descrição:", taskDesc); // DEBUG 3: Verifica se a descrição foi pega

                // Se a linha ainda não foi salva (não tem ID), apenas remove
                if (!taskId) {
                     console.log("Tarefa nova não salva, removendo linha diretamente."); // DEBUG 4a
                     $row.remove();
                     isAddingNewRow = false; 
                     // Adiciona a mensagem "Nenhuma tarefa" de volta se a tabela ficar vazia
                      if ($('#checklist-tbody tr:not(#no-tasks-row)').length === 0) {
                         $('#checklist-tbody').append('<tr id="no-tasks-row"><td colspan="11" style="text-align: center;">Nenhuma tarefa encontrada.</td></tr>');
                      }
                     return; 
                }

                console.log("Mostrando confirmação..."); // DEBUG 5: Verifica se chega antes da confirmação

                if (confirm(`Tem certeza que deseja excluir "${taskDesc}"? Esta ação não pode ser desfeita.`)) {
                    console.log("Confirmação OK recebida."); // DEBUG 6: Verifica se a confirmação foi aceita
                    
                    fetch(`/api/tarefa_inline/delete/${taskId}`, {
                        method: 'DELETE',
                        headers: { /* Adicionar CSRF se necessário */ }
                    })
                    .then(response => {
                         console.log("Resposta Fetch recebida:", response.status); // DEBUG 7: Vê o status da resposta
                         if (!response.ok) { // Verifica se a resposta não foi bem-sucedida (status != 2xx)
                             throw new Error(`Erro HTTP: ${response.status}`);
                         }
                         return response.json();
                    })
                    .then(data => {
                        console.log("Dados JSON recebidos:", data); // DEBUG 8: Vê a resposta JSON
                        if (data.success) {
                             console.log("Exclusão bem-sucedida no servidor, removendo linha..."); // DEBUG 9a
                            $row.fadeOut(300, function() { 
                                $(this).remove(); 
                                 // Adiciona a mensagem "Nenhuma tarefa" de volta se a tabela ficar vazia
                                 if ($('#checklist-tbody tr:not(#no-tasks-row)').length === 0) { // Verifica linhas exceto a de 'nenhuma tarefa'
                                     $('#checklist-tbody').append('<tr id="no-tasks-row"><td colspan="11" style="text-align: center;">Nenhuma tarefa encontrada.</td></tr>');
                                 }
                            });
                        } else { 
                            console.error("Erro retornado pelo servidor:", data.message); // DEBUG 9b: Mostra erro do servidor
                            alert(`Erro ao excluir: ${data.message}`); 
                        }
                    })
                    .catch(error => { 
                        console.error('Erro na requisição Fetch:', error); // DEBUG 10: Mostra erro de rede/fetch
                        alert('Erro de comunicação ao excluir a tarefa.'); 
                    });
                } else {
                     console.log("Confirmação CANCELADA pelo usuário."); // DEBUG 11: Se o usuário cancelou
                }
            });
            // --- Fim Excluir Linha ---

        });
    </script>
</body>
</html>