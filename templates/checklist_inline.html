<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Checklist Editável: {{ projeto.nome }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        /* ... (Estilos CSS da Fase 3 inalterados) ... */
        .new-task-row td { background-color: #eef2f5; } /* Destaca a linha nova */
        .btn-save-new { background-color: #28a745; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-cancel-new { background-color: #dc3545; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px;}
    </style>
</head>
<body>
    <div style="background-color: #34495e; color: white; padding: 10px 20px; text-align: right; margin-bottom: 15px;">
        {% if session.user_name %}
            <span>Bem-vindo, <strong>{{ session.user_name }}</strong>!</span>
            <a href="{{ url_for('logout') }}" style="color: #ecf0f1; margin-left: 15px; text-decoration: none;">Sair</a>
        {% endif %}
    </div>

    <div class="container">
        <div class="header-actions">
            <h1>Checklist Editável: {{ projeto.nome }}</h1>
            <div class="actions-group">
                <button id="add-task-btn" class="button new">Adicionar Tarefa</button> <button id="add-title-btn" class="button new" style="background-color: #5bc0de;">Adicionar Título</button> <a href="{{ url_for('projetos') }}" class="button">Voltar à Lista</a>
            </div>
        </div>

        <table class="checklist-table">
            <thead>
                <tr>
                    <th class="col-item">Item</th>
                    <th class="col-atividade">Atividade</th>
                    <th class="col-data">Data Início</th>
                    <th class="col-data">Data Término</th>
                    <th class="col-duracao">Duração</th>
                    <th class="col-responsavel">Responsáveis</th> 
                    <th class="col-status">Status</th>
                    <th class="col-local">Local</th>
                    <th class="col-obs">Observações</th>
                    <th class="col-actions"></th>
                </tr>
            </thead>
            <tbody id="checklist-tbody"> 
                {% for tarefa in tarefas %}
                    {% if tarefa.tipo == 'titulo' %}
                        <tr class="task-header-inline" data-task-id="{{ tarefa.id }}" data-task-type="titulo">
                             <td class="col-item editable" data-field="atividade_id">{{ tarefa.atividade_id }}</td> 
                            <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data"></td> <td class="col-data"></td> <td class="col-duracao"></td>
                            <td class="col-responsavel"></td> <td class="col-status"></td> <td class="col-local"></td>
                            <td class="col-obs"></td>
                            <td class="col-actions"><span class="btn-delete-task" title="Excluir Título">&times;</span></td>
                        </tr>
                    {% else %}
                        {% set level = (tarefa.atividade_id.count('.') + 1) if tarefa.atividade_id else 1 %}
                        <tr class="task-item-inline" data-task-id="{{ tarefa.id }}" data-task-type="tarefa" data-level="{{ level }}">
                            <td class="col-item editable" data-field="atividade_id">{{ tarefa.atividade_id }}</td>
                            <td class="col-atividade editable" data-field="descricao">{{ tarefa.descricao }}</td>
                            <td class="col-data editable" data-field="data_inicio">{{ tarefa.data_inicio | dateformat }}</td>
                            <td class="col-data editable" data-field="data_termino">{{ tarefa.data_termino | dateformat }}</td>
                            <td class="col-duracao">{{ tarefa.duracao_calculada }}</td>
                            <td class="col-responsavel editable" data-field="responsaveis">{{ tarefa.responsaveis or '---' }}</td>
                            <td class="col-status editable" data-field="status">{{ tarefa.status }}</td>
                            <td class="col-local editable" data-field="local_execucao">{{ tarefa.local_execucao or '---' }}</td>
                            <td class="col-obs editable" data-field="observacoes">{{ tarefa.observacoes or '' }}</td>
                            <td class="col-actions"><span class="btn-delete-task" title="Excluir Tarefa">&times;</span></td>
                        </tr>
                    {% endif %}
                {% else %}
                    <tr id="no-tasks-row">
                        <td colspan="10" style="text-align: center;">Nenhuma tarefa encontrada para este projeto.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    </div>

    <script>
        // Passa dados do Flask para o JavaScript
        const TECNICOS = {{ tecnicos_list | tojson }};
        const STATUS_LIST = {{ status_list | tojson }};
        const LOCAIS_LIST = {{ locais_list | tojson }};
        const PROJETO_ID = {{ projeto.id }};

        $(document).ready(function() {
            let activeInput = null;
            let isAddingNewRow = false; // Flag para evitar múltiplas linhas novas

            function revertToText(cell, displayValue) {
                $(cell).empty().text(displayValue).addClass('editable');
                activeInput = null;
                setTimeout(() => { $(cell).removeClass('saved-success saved-error saving'); }, 1500);
            }

            // --- Lógica de Edição Inline (ajustada levemente) ---
            $('#checklist-tbody').on('dblclick', 'td.editable', function() {
                // Não permite editar se estiver adicionando uma nova linha
                 if (isAddingNewRow) return;

                if (activeInput) {
                    const cell = $(activeInput).closest('td');
                    // Tenta salvar antes de reverter
                    $(activeInput).trigger('blur'); 
                    // Se o blur não reverteu (erro?), força a reversão
                    if ($(cell).find('input, select, textarea').length > 0) {
                        revertToText(cell, $(activeInput).data('original-value'));
                    }
                }

                const cell = this;
                const originalValue = $(cell).text().trim() === '---' ? '' : $(cell).text().trim();
                const fieldName = $(cell).data('field');
                const taskId = $(cell).closest('tr').data('task-id');
                const taskType = $(cell).closest('tr').data('task-type');

                if (taskType === 'titulo' && !['descricao', 'atividade_id'].includes(fieldName)) return;
                if (!taskId) return; // Não edita linhas que ainda não foram salvas

                $(cell).removeClass('editable');
                $(cell).empty(); 

                let inputElement;
                let isMultiSelect = false;

                // --- Criação do Input (sem grandes mudanças) ---
                if (fieldName === 'descricao' || fieldName === 'observacoes') {
                    inputElement = $('<textarea>').val(originalValue);
                } else if (fieldName === 'data_inicio' || fieldName === 'data_termino') {
                    let dateValue = originalValue;
                    if (originalValue.includes('/')) {
                        const parts = originalValue.split('/');
                        if(parts.length === 3) dateValue = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                    inputElement = $('<input type="date">').val(dateValue);
                } else if (fieldName === 'status') {
                    inputElement = $('<select>');
                    STATUS_LIST.forEach(status => {
                        inputElement.append($('<option>', { value: status, text: status, selected: originalValue === status }));
                    });
                } else if (fieldName === 'responsaveis') {
                    inputElement = $('<select multiple size="5">');
                    const selectedValues = originalValue.split(',').map(s => s.trim());
                    TECNICOS.forEach(tecnico => {
                        inputElement.append($('<option>', { value: tecnico, text: tecnico, selected: selectedValues.includes(tecnico) }));
                    });
                    isMultiSelect = true;
                } else if (fieldName === 'local_execucao') {
                     inputElement = $('<select>');
                     inputElement.append($('<option>', { value: '', text: 'Selecione' }));
                     LOCAIS_LIST.forEach(local => {
                        inputElement.append($('<option>', { value: local, text: local, selected: originalValue === local }));
                     });
                } else { // atividade_id (para tarefas e títulos)
                    inputElement = $('<input type="text">').val(originalValue);
                }
                // --- Fim Criação Input ---

                inputElement.data('original-value', originalValue);
                $(cell).append(inputElement);
                inputElement.focus(); 
                activeInput = inputElement;

                // --- Lógica de Salvamento AJAX (blur) ---
                inputElement.on('blur', function() {
                    let newValue = $(this).val();
                    const originalValueFromData = $(this).data('original-value');
                    
                    if (isMultiSelect) {
                        newValue = $(this).val() ? $(this).val().join(', ') : '';
                    }

                    if (newValue !== originalValueFromData) {
                        $(cell).addClass('saving'); 

                        fetch(`/api/tarefa_inline/update/${taskId}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ field: fieldName, value: newValue })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                $(cell).removeClass('saving').addClass('saved-success');
                                let displayValue = newValue;
                                if (fieldName === 'data_inicio' || fieldName === 'data_termino') {
                                    if (newValue && newValue.includes('-')) {
                                        const parts = newValue.split('-');
                                        if(parts.length === 3) displayValue = `${parts[2].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[0]}`;
                                    }
                                }
                                if (displayValue === '' && (fieldName === 'responsaveis' || fieldName === 'local_execucao')) {
                                    displayValue = '---';
                                }
                                revertToText(cell, displayValue);
                            } else {
                                $(cell).removeClass('saving').addClass('saved-error'); 
                                alert(`Erro ao salvar: ${data.message}`);
                                revertToText(cell, originalValueFromData); 
                            }
                        })
                        .catch(error => {
                            $(cell).removeClass('saving').addClass('saved-error'); 
                            console.error('Erro na requisição:', error);
                            alert('Erro de comunicação ao salvar.');
                            revertToText(cell, originalValueFromData); 
                        });
                    } else {
                        revertToText(cell, originalValueFromData);
                    }
                });
                // --- Fim Salvamento AJAX ---

                // --- Listeners Enter/Esc (sem mudanças) ---
                 if (inputElement.prop('tagName') !== 'TEXTAREA' && !isMultiSelect) { 
                    inputElement.on('keydown', function(e) {
                        if (e.key === 'Enter') { e.preventDefault(); $(this).trigger('blur'); } 
                        else if (e.key === 'Escape') { revertToText(cell, originalValue); }
                    });
                } else {
                     inputElement.on('keydown', function(e) {
                         if (e.key === 'Escape') { revertToText(cell, originalValue); }
                     });
                }
            });
            // --- Fim Lógica Edição ---


            // --- ALTERAÇÃO APLICADA AQUI: Lógica para Adicionar Nova Linha ---
            function createNewRow(type = 'tarefa') {
                if (isAddingNewRow) return; // Impede adicionar múltiplas linhas
                isAddingNewRow = true;
                 $('#no-tasks-row').remove(); // Remove a mensagem "Nenhuma tarefa" se existir

                const $tbody = $('#checklist-tbody');
                const $newRow = $('<tr class="new-task-row">'); // Classe para identificar e estilizar

                // Adiciona as células com os inputs/selects apropriados
                $newRow.append('<td><input type="text" name="atividade_id" placeholder="Ex: 1.1"></td>');
                $newRow.append('<td><textarea name="descricao" placeholder="Descrição da ' + type + '"></textarea></td>');
                
                // Campos específicos para TAREFA
                if (type === 'tarefa') {
                    $newRow.append('<td><input type="date" name="data_inicio"></td>');
                    $newRow.append('<td><input type="date" name="data_termino"></td>');
                    $newRow.append('<td class="col-duracao">N/D</td>'); // Duração não é editável na criação
                    
                    let respSelect = '<select name="responsaveis" multiple size="3">';
                    TECNICOS.forEach(t => { respSelect += `<option value="${t}">${t}</option>`; });
                    respSelect += '</select>';
                    $newRow.append(`<td>${respSelect}</td>`);
                    
                    let statusSelect = '<select name="status">';
                    STATUS_LIST.forEach(s => { statusSelect += `<option value="${s}" ${s === 'Planejada' ? 'selected' : ''}>${s}</option>`; });
                    statusSelect += '</select>';
                    $newRow.append(`<td>${statusSelect}</td>`);

                    let localSelect = '<select name="local_execucao"><option value="">Selecione</option>';
                    LOCAIS_LIST.forEach(l => { localSelect += `<option value="${l}">${l}</option>`; });
                    localSelect += '</select>';
                    $newRow.append(`<td>${localSelect}</td>`);

                    $newRow.append('<td><textarea name="observacoes"></textarea></td>');
                } else { // Campos vazios para TÍTULO
                     $newRow.append('<td colspan="7"></td>'); // Ocupa 7 colunas vazias
                }

                // Botões Salvar/Cancelar
                $newRow.append('<td class="col-actions"><button class="btn-save-new">Salvar</button><button class="btn-cancel-new">&times;</button></td>');

                $tbody.append($newRow); // Adiciona a linha ao final da tabela
            }

            // Listener para o botão "Adicionar Tarefa"
            $('#add-task-btn').on('click', function() {
                createNewRow('tarefa');
            });
            
             // Listener para o botão "Adicionar Título"
            $('#add-title-btn').on('click', function() {
                createNewRow('titulo');
            });

            // Listener para o botão "Cancelar Nova" (delegação de evento)
            $('#checklist-tbody').on('click', '.btn-cancel-new', function() {
                $(this).closest('tr').remove();
                isAddingNewRow = false;
                // Se a tabela ficar vazia, adiciona a mensagem de volta
                 if ($('#checklist-tbody tr').length === 0) {
                     $('#checklist-tbody').append('<tr id="no-tasks-row"><td colspan="10" style="text-align: center;">Nenhuma tarefa encontrada para este projeto.</td></tr>');
                 }
            });

            // Listener para o botão "Salvar Nova" (delegação de evento)
            $('#checklist-tbody').on('click', '.btn-save-new', function() {
                const $row = $(this).closest('tr');
                const taskType = $row.find('textarea[name="descricao"]').attr('placeholder').includes('Título') ? 'titulo' : 'tarefa';
                
                // Coleta os dados da nova linha
                const newData = {
                    tipo: taskType,
                    atividade_id: $row.find('input[name="atividade_id"]').val(),
                    descricao: $row.find('textarea[name="descricao"]').val(),
                };
                
                if (taskType === 'tarefa') {
                    newData.data_inicio = $row.find('input[name="data_inicio"]').val() || null;
                    newData.data_termino = $row.find('input[name="data_termino"]').val() || null;
                    newData.responsaveis = $row.find('select[name="responsaveis"]').val() ? $row.find('select[name="responsaveis"]').val().join(', ') : '';
                    newData.status = $row.find('select[name="status"]').val();
                    newData.local_execucao = $row.find('select[name="local_execucao"]').val() || null;
                    newData.observacoes = $row.find('textarea[name="observacoes"]').val();
                    // Predecessoras podem ser adicionadas na edição
                }

                // Validação simples
                if (!newData.descricao) {
                    alert('A Descrição é obrigatória.');
                    return;
                }

                console.log("Enviando para criar:", newData); // DEBUG

                // Envia para a API de criação
                fetch(`/api/tarefa_inline/create/${PROJETO_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const newTask = data.tarefa;
                        // Atualiza a linha com os dados salvos
                        $row.removeClass('new-task-row').addClass(newTask.tipo === 'titulo' ? 'task-header-inline' : 'task-item-inline');
                        $row.attr('data-task-id', newTask.id);
                        $row.attr('data-task-type', newTask.tipo);
                        
                        $row.find('td').eq(0).text(newTask.atividade_id || '').addClass('editable').attr('data-field', 'atividade_id');
                        $row.find('td').eq(1).text(newTask.descricao).addClass('editable').attr('data-field', 'descricao');

                        if (newTask.tipo === 'tarefa') {
                            $row.find('td').eq(2).text(formatDate(newTask.data_inicio)).addClass('editable').attr('data-field', 'data_inicio');
                            $row.find('td').eq(3).text(formatDate(newTask.data_termino)).addClass('editable').attr('data-field', 'data_termino');
                            $row.find('td').eq(4).text(newTask.duracao_calculada); // Duração calculada
                            $row.find('td').eq(5).text(newTask.responsaveis || '---').addClass('editable').attr('data-field', 'responsaveis');
                            $row.find('td').eq(6).text(newTask.status).addClass('editable').attr('data-field', 'status');
                            $row.find('td').eq(7).text(newTask.local_execucao || '---').addClass('editable').attr('data-field', 'local_execucao');
                            $row.find('td').eq(8).text(newTask.observacoes || '').addClass('editable').attr('data-field', 'observacoes');
                        } else {
                            // Limpa colunas desnecessárias para títulos
                             $row.find('td').slice(2, 9).text(''); 
                        }

                        // Substitui botões Salvar/Cancelar por Excluir
                        $row.find('td').last().empty().append('<span class="btn-delete-task" title="Excluir">&times;</span>');
                        
                        isAddingNewRow = false; // Permite adicionar outra linha
                    } else {
                        alert(`Erro ao criar: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Erro na requisição de criação:', error);
                    alert('Erro de comunicação ao criar a tarefa.');
                });
            });
             // --- Fim Adicionar Nova Linha ---

            // --- Lógica de Exclusão (Fase 5 - virá aqui) ---

            // Função helper para formatar data (simples)
            function formatDate(dateString) {
                if (!dateString || !dateString.includes('-')) return '';
                const parts = dateString.split('-');
                if (parts.length !== 3) return '';
                return `${parts[2].padStart(2, '0')}/${parts[1].padStart(2, '0')}/${parts[0]}`;
            }

        });
    </script>
</body>
</html>